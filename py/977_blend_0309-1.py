#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Sun Mar 10 06:48:21 2019

@author: Kazuki
"""

import numpy as np
import pandas as pd
import utils


SUBMIT_FILE_PATH = '../output/0309-1.csv.gz'

COMMENT = 'mean(ireko*4) + mean(tosh*3) + onodera + mean(nyanp*3) + nejumi'

EXE_SUBMIT = True

usecols = ['HasDetections']

# =============================================================================
# ireko
# =============================================================================
ireko707    = pd.Series(np.load('../external/sub/ireko707/test_preds.npy'), name='ireko707')
ireko708    = pd.Series(np.load('../external/sub/ireko708/test_preds.npy'), name='ireko708')
ireko708_v2 = pd.Series(np.load('../external/sub/ireko708_v2/test_preds.npy'), name='ireko708_v2')
ireko709    = pd.Series(np.load('../external/sub/ireko709/test_preds.npy'), name='ireko709')

ireko = ireko707.rank() + ireko708.rank() + ireko708_v2.rank() + ireko709.rank()
ireko = ireko.rank()

# =============================================================================
# tosh
# =============================================================================
tosh708 = pd.read_csv('../external/sub/subNN_v1722.csv.gz', usecols=usecols)['HasDetections']
tosh709 = 1-pd.read_csv('../external/sub/subNN_v176.csv.gz', usecols=usecols)['HasDetections']
tosh709_v2 = 1-pd.read_csv('../external/sub/subNN_v1763.csv.gz', usecols=usecols)['HasDetections']

tosh = tosh708.rank() + tosh709.rank() + tosh709_v2.rank()
tosh = tosh.rank()


# =============================================================================
# onodera
# =============================================================================
onodera = pd.read_csv('../output/0308-2.csv.gz', usecols=usecols)['HasDetections']
onodera = (1-onodera).rank()

# =============================================================================
# nyanp
# =============================================================================
nyanp709_wo = pd.read_csv('../external/sub/sub_wo1_x24.csv.gz', usecols=usecols)['HasDetections']
nyanp709_w = pd.read_csv('../external/sub/sub_w1_x24.csv.gz', usecols=usecols)['HasDetections']
nyanp709_v2 = pd.read_csv('../external/sub/sub_lgbm_te_01100101102103173613614615701_auc0.745.csv.csv.gz', usecols=usecols)['HasDetections']

nyanp = nyanp709_wo.rank() + nyanp709_w.rank() + nyanp709_v2.rank()
nyanp = nyanp.rank()


# =============================================================================
# nejumi
# =============================================================================
nejumi = pd.read_csv('../external/sub/1_m_nejumi_0098_seed71_test.csv.gz', usecols=usecols)['HasDetections']
nejumi.name = 'nejumi712'
nejumi = 1-nejumi

nejumi = nejumi.rank()


# =============================================================================
# 
# =============================================================================

y_pred = ireko + tosh + onodera + nyanp + nejumi
y_pred /= y_pred.max()

sub = pd.read_csv('../input/sample_submission.csv.zip')
sub['HasDetections'] = y_pred.values

sub['HasDetections'] = 1 - sub['HasDetections']


print(f'corr with {utils.SUB_BEST}')
sub_best = pd.read_csv(utils.SUB_BEST)
print('with mybest:', sub['HasDetections'].corr( sub_best['HasDetections'], method='spearman') )

# save
sub.to_csv(SUBMIT_FILE_PATH, index=False, compression='gzip')

# =============================================================================
# submission
# =============================================================================
if EXE_SUBMIT:
    print('submit')
    utils.submit(SUBMIT_FILE_PATH, COMMENT)

