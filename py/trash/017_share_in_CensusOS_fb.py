#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Wed Feb 27 07:04:33 2019

@author: Kazuki
"""

import numpy as np
import pandas as pd
from tqdm import tqdm
import os, gc
import utils
utils.start(__file__)
#==============================================================================


PREF = 'f017'

categorical_w_version = [
                         'Census_OSUILocaleIdentifier',
                         'AVProductsInstalled',
                         'Census_FirmwareVersionIdentifier',
                         'Wdft_IsGamer',
                         'Census_ThresholdOptIn',
                         'RtpStateBitfield',
                         'Census_IsSecureBootEnabled',
                         'AVProductsEnabled',
                         'HasTpm',
                         'IsProtected',
                         'Census_PrimaryDiskTypeName',
                         'PuaMode',
                         'DefaultBrowsersIdentifier',
                         'IsSxsPassiveMode',
                         'OrganizationIdentifier',
                         'Census_IsAlwaysOnAlwaysConnectedCapable',
                         'ProductName',
                         'GeoNameIdentifier',
                         'Census_IsVirtualDevice',
                         'Census_PowerPlatformRoleName',
                         'Census_IsTouchEnabled',
                         'Census_OSSkuName',
                         'OsPlatformSubRelease',
                         'Census_FlightRing',
                         'Census_OSEdition',
                         'Census_IsPortableOperatingSystem',
                         'Firewall',
                         'OsBuildLab',
                         'Census_DeviceFamily',
                         'Census_IsPenCapable',
                         'SMode',
                         'Platform',
                         'Census_IsFlightingInternal',
                         'Census_OEMNameIdentifier',
                         'Census_InternalBatteryType',
                         'OsBuild',
                         'Census_HasOpticalDiskDrive',
                         'Census_IsWIMBootEnabled',
                         'Census_OSBuildRevision',
                         'CityIdentifier',
                         'IeVerIdentifier',
                         'Census_ProcessorClass',
                         'OsSuite',
                         'Census_IsFlightsDisabled',
                         'Census_ChassisTypeName',
                         'LocaleEnglishNameIdentifier',
                         'Census_OSArchitecture',
                         'CountryIdentifier',
                         'Census_OSInstallLanguageIdentifier',
                         'Census_OSInstallTypeName',
                         'Census_OSBuildNumber',
                         'AutoSampleOptIn',
                         'OsVer',
                         'SkuEdition',
                         'UacLuaenable',
                         'Census_OEMModelIdentifier',
                         'Census_OSBranch',
                         'Processor',
                         'Census_ProcessorModelIdentifier',
                         'Census_ActivationChannel',
                         'IsBeta',
                         'Census_MDC2FormFactor',
                         'Census_OSWUAutoUpdateOptionsName',
                         'AVProductStatesIdentifier',
                         'Census_GenuineStateName',
                         'Census_FirmwareManufacturerIdentifier',
                         'Wdft_RegionIdentifier',
                         'Census_ProcessorManufacturerIdentifier',  
                         'OsBuildLab_major',
                         'OsBuildLab_minor',
                         'OsBuildLab_build',
                         'OsBuildLab_architecture',
                         
                         
                         'EngineVersion',
                         'AppVersion',
                         'AvSigVersion',
                         'Census_OSVersion',
                         
                         ]

cat = 'Census_OSVersion'

def fe(input_path, output_path):
    """
    input_path  = '../data/train.f'
    output_path = '../data/train_{PREF}.f'
    """
    
    print('loading...', input_path)
    base = pd.read_feather(input_path)[categorical_w_version]
    
    df = pd.DataFrame(sorted(base[cat].unique()), columns=[cat])
    df['v'] = df[cat].map(lambda x: '.'.join(x.split('.')[:-1]) )
    df['forward'] = df.groupby('v').shift(1)[cat]
    df['backward'] = df.groupby('v').shift(-1)[cat]
    
    di_f = dict(zip(df[cat], df['forward']))
    di_b = dict(zip(df[cat], df['backward']))
    
    base_f = base.copy()
    base_f[cat] = base_f[cat].map(di_f)
    base_f.dropna(subset=[cat], inplace=True)
    
    base_b = base.copy()
    base_b[cat] = base_b[cat].map(di_b)
    base_b.dropna(subset=[cat], inplace=True)
    
    augmented = pd.concat([base, base_f, base_b], ignore_index=True)
    del df, base_f, base_b; gc.collect()
    
    
    feature = pd.DataFrame(index=base.index)
    
    for c in tqdm(categorical_w_version):
        if cat == c:
            continue
        col = [cat, c]
        df = augmented.groupby(col).size() / augmented.groupby(cat).size()
        df = df.reset_index()
        
        feature[f'{PREF}_{c}-in-{cat}'] = pd.merge(base[col], df, on=col, how='left')[0]
    
    print('writing...', output_path)
    feature.to_feather(output_path)
    
    return

fe('../data/train.f', f'../data/train_{PREF}.f')
fe('../data/test.f',  f'../data/test_{PREF}.f')


#==============================================================================
utils.end(__file__)
#utils.stop_instance()

