#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Tue Jan 22 21:53:46 2019

@author: kazuki.onodera
"""

import numpy as np
import pandas as pd
import os, gc
from multiprocessing import Pool

import utils


for d in ['../data', '../feature']:
    os.system(f'rm -rf {d}')
    os.system(f'mkdir  {d}')


dtypes = {
        #'MachineIdentifier':                                    'objectst',
        'ProductName':                                          'objectst',
        'EngineVersion':                                        'objectst',
        'AppVersion':                                           'objectst',
        'AvSigVersion':                                         'objectst',
        'IsBeta':                                               'int8',
        'RtpStateBitfield':                                     'float16',
        'IsSxsPassiveMode':                                     'int8',
        'DefaultBrowsersIdentifier':                            'float16',
        'AVProductStatesIdentifier':                            'float32',
        'AVProductsInstalled':                                  'float16',
        'AVProductsEnabled':                                    'float16',
        'HasTpm':                                               'int8',
        'CountryIdentifier':                                    'int32',
        'CityIdentifier':                                       'float32',
        'OrganizationIdentifier':                               'float16',
        'GeoNameIdentifier':                                    'float32',
        'LocaleEnglishNameIdentifier':                          'int32',
        'Platform':                                             'objectst',
        'Processor':                                            'objectst',
        'OsVer':                                                'objectst',
        'OsBuild':                                              'int16',
        'OsSuite':                                              'int16',
        'OsPlatformSubRelease':                                 'objectst',
        'OsBuildLab':                                           'objectst',
        'SkuEdition':                                           'objectst',
        'IsProtected':                                          'float16',
        'AutoSampleOptIn':                                      'int8',
        'PuaMode':                                              'objectst',
        'SMode':                                                'float16',
        'IeVerIdentifier':                                      'float32',
        'SmartScreen':                                          'objectst',
        'Firewall':                                             'float16',
        'UacLuaenable':                                         'float64',
        'Census_MDC2FormFactor':                                'objectst',
        'Census_DeviceFamily':                                  'objectst',
        'Census_OEMNameIdentifier':                             'float32',
        'Census_OEMModelIdentifier':                            'float32',
        'Census_ProcessorCoreCount':                            'float16',
        'Census_ProcessorManufacturerIdentifier':               'float16',
        'Census_ProcessorModelIdentifier':                      'float32',
        'Census_ProcessorClass':                                'objectst',
        'Census_PrimaryDiskTotalCapacity':                      'float32',
        'Census_PrimaryDiskTypeName':                           'objectst',
        'Census_SystemVolumeTotalCapacity':                     'float32',
        'Census_HasOpticalDiskDrive':                           'int8',
        'Census_TotalPhysicalRAM':                              'float32',
        'Census_ChassisTypeName':                               'objectst',
        'Census_InternalPrimaryDiagonalDisplaySizeInInches':    'float32',
        'Census_InternalPrimaryDisplayResolutionHorizontal':    'float32',
        'Census_InternalPrimaryDisplayResolutionVertical':      'float32',
        'Census_PowerPlatformRoleName':                         'objectst',
        'Census_InternalBatteryType':                           'objectst',
        'Census_InternalBatteryNumberOfCharges':                'float32',
        'Census_OSVersion':                                     'objectst',
        'Census_OSArchitecture':                                'objectst',
        'Census_OSBranch':                                      'objectst',
        'Census_OSBuildNumber':                                 'int32',
        'Census_OSBuildRevision':                               'int32',
        'Census_OSEdition':                                     'objectst',
        'Census_OSSkuName':                                     'objectst',
        'Census_OSInstallTypeName':                             'objectst',
        'Census_OSInstallLanguageIdentifier':                   'float16',
        'Census_OSUILocaleIdentifier':                          'int32',
        'Census_OSWUAutoUpdateOptionsName':                     'objectst',
        'Census_IsPortableOperatingSystem':                     'int8',
        'Census_GenuineStateName':                              'objectst',
        'Census_ActivationChannel':                             'objectst',
        'Census_IsFlightingInternal':                           'float16',
        'Census_IsFlightsDisabled':                             'float16',
        'Census_FlightRing':                                    'objectst',
        'Census_ThresholdOptIn':                                'float16',
        'Census_FirmwareManufacturerIdentifier':                'float32',
        'Census_FirmwareVersionIdentifier':                     'float32',
        'Census_IsSecureBootEnabled':                           'int8',
        'Census_IsWIMBootEnabled':                              'float16',
        'Census_IsVirtualDevice':                               'float16',
        'Census_IsTouchEnabled':                                'int8',
        'Census_IsPenCapable':                                  'int8',
        'Census_IsAlwaysOnAlwaysConnectedCapable':              'float16',
        'Wdft_IsGamer':                                         'float16',
        'Wdft_RegionIdentifier':                                'float32',
        'HasDetections':                                        'int8'
    }

def main(args):
    
    input_path, output_path = args
    df = pd.read_csv(input_path, dtype=dtypes)
    df.to_pickle(output_path)
    
    if 'train' in input_path:
        df['HasDetections'].to_pickle('../data/target.pkl')
    
    return


# =============================================================================
# main
# =============================================================================
if __name__ == "__main__":
    utils.start(__file__)
    
    argss = []
    argss.append(['../input/train.csv.zip', '../data/train.pkl'])
    argss.append(['../input/test.csv.zip', '../data/test.pkl'])
    
    pool = Pool( 2 )
    pool.map(main, argss)
    pool.close()
    
    utils.end(__file__)


