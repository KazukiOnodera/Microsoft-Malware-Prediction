#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Thu Feb 28 07:01:11 2019

@author: Kazuki
"""

import numpy as np
import pandas as pd
from tqdm import tqdm
import os
from itertools import combinations
import utils
utils.start(__file__)
#==============================================================================


PREF = 'f019'

cat = 'AvSigVersion'

categorical_w_version = [
                        'AVProductStatesIdentifier',
                        'AVProductsInstalled',
                        'Wdft_IsGamer',
                        'Census_OSInstallTypeName',
                        'Wdft_RegionIdentifier',
                        'OrganizationIdentifier',
                        'CityIdentifier',
                        'SMode',
                        'AppVersion',
                        'IsProtected',
                        'RtpStateBitfield',
                        'Census_FirmwareVersionIdentifier',
                        'Census_OEMModelIdentifier',
                        'Census_FirmwareManufacturerIdentifier',
                        'Census_OEMNameIdentifier',
                        'CountryIdentifier',
                        'Firewall',
                        'Census_ProcessorModelIdentifier',
                        'Census_ActivationChannel',
                        'AVProductsEnabled',
                        'Census_IsFlightsDisabled',
                        'Census_IsAlwaysOnAlwaysConnectedCapable',
                        'Census_ProcessorManufacturerIdentifier',
                        'Processor',
                        'Census_IsVirtualDevice',
                        
                         ]

comb = list(combinations(categorical_w_version, 2))
comb = [col for col in comb if cat not in col]



def fe(input_path, output_path):
    """
    input_path  = '../data/train.f'
    output_path = '../data/train_{PREF}.f'
    """
    
    print('loading...', input_path)
    base = pd.read_feather(input_path)[categorical_w_version]
    
    feature = pd.DataFrame(index=base.index)
    
    for c2 in tqdm(comb):
        c2 = list(c2)
        c3 = [cat] + c2
        df = base.groupby(c3).size() / base.groupby(cat).size()
        df = df.reset_index()
        
        feature[f'{PREF}_{"-".join(c2)}-in-{cat}'] = pd.merge(base[c3], df, on=c3, how='left')[0]
    
    print('writing...', output_path)
    feature.to_feather(output_path)
    
    return



fe('../data/train.f', f'../data/train_{PREF}.f')
fe('../data/test.f',  f'../data/test_{PREF}.f')


#==============================================================================
utils.end(__file__)

