#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Thu Jan 31 21:03:02 2019

@author: Kazuki
"""

import numpy as np
import pandas as pd
import os, gc
import utils
utils.start(__file__)

PREF = 'f004'




tr = pd.read_feather('../data/train.f')

te = pd.read_feather('../data/test.f')


# AS timestamp
datedictAS = np.load('../external/AvSigVersionTimestamps.npy')[()]
tr['AvSigVersion_datetime'] = tr['AvSigVersion'].map(datedictAS)
te['AvSigVersion_datetime'] = te['AvSigVersion'].map(datedictAS)


tr['AvSigVersion_date'] = tr['AvSigVersion_datetime'].dt.date
te['AvSigVersion_date'] = te['AvSigVersion_datetime'].dt.date



tbl = tr[['AvSigVersion_date']].append(te[['AvSigVersion_date']]).groupby('AvSigVersion_date').size()
tbl.name = 'cnt'
tbl = tbl.reset_index()

tbl['cnt_norm'] = tbl.cnt / tbl.cnt.sum()

alldate = pd.DataFrame()
alldate['AvSigVersion_date'] = pd.Series(pd.date_range(tbl['AvSigVersion_date'].min(), 
                                       tbl['AvSigVersion_date'].max())).dt.date


tbl = pd.merge(alldate, tbl, on='AvSigVersion_date', how='outer')

tbl.fillna(0, inplace=True)

tbl['lead_10d_sum'] = tbl.cnt.rolling(10).sum().shift(-9)
tbl['lead_10d_mean'] = tbl.cnt.rolling(10).mean().shift(-9)
tbl['lead_10d_std'] = tbl.cnt.rolling(10).std().shift(-9)

tbl.sort_values('AvSigVersion_date', ascending=False, inplace=True)
tbl['lag_10d_sum']  = tbl.cnt.rolling(10).sum().shift(-9)
tbl['lag_10d_mean'] = tbl.cnt.rolling(10).mean().shift(-9)
tbl['lag_10d_std']  = tbl.cnt.rolling(10).std().shift(-9)

#tbl.set_index('AvSigVersion_date', inplace=True)

tr_f = pd.DataFrame(tr['AvSigVersion_date'])
te_f = pd.DataFrame(te['AvSigVersion_date'])

tr_f = pd.merge(tr_f, tbl, on='AvSigVersion_date', how='left')
te_f = pd.merge(te_f, tbl, on='AvSigVersion_date', how='left')

del tr_f['AvSigVersion_date'], te_f['AvSigVersion_date']

utils.reduce_mem_usage(tr_f)
utils.reduce_mem_usage(te_f)

tr_f.add_prefix(PREF+'_').to_feather(f'../data/train_{PREF}.f')
te_f.add_prefix(PREF+'_').to_feather(f'../data/test_{PREF}.f')



utils.end(__file__)

