#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Fri Feb  1 18:35:46 2019

@author: Kazuki
"""

import numpy as np
import pandas as pd
import os, gc
import utils
utils.start(__file__)

PREF = 'f009'




tr = pd.read_feather('../data/train.f')

te = pd.read_feather('../data/test.f')


# OS timestamp
datedictOS = np.load('../external/OSVersionTimestamps.npy')[()]
tr['Census_OSVersion_datetime'] = tr['Census_OSVersion'].map(datedictOS)
te['Census_OSVersion_datetime'] = te['Census_OSVersion'].map(datedictOS)


tr['Census_OSVersion_date'] = tr['Census_OSVersion_datetime'].dt.date
te['Census_OSVersion_date'] = te['Census_OSVersion_datetime'].dt.date



tbl = tr[['Census_OSVersion_date']].append(te[['Census_OSVersion_date']]).groupby('Census_OSVersion_date').size()
tbl.name = 'cnt'
tbl = tbl.reset_index()

tbl['cnt_norm'] = tbl.cnt / tbl.cnt.sum()

alldate = pd.DataFrame()
alldate['Census_OSVersion_date'] = pd.Series(pd.date_range(tbl['Census_OSVersion_date'].min(), 
                                       tbl['Census_OSVersion_date'].max())).dt.date


tbl = pd.merge(alldate, tbl, on='Census_OSVersion_date', how='outer')

tbl.fillna(0, inplace=True)

tbl['lead_10d_sum'] = tbl.cnt.rolling(10).sum().shift(-9)
tbl['lead_10d_mean'] = tbl.cnt.rolling(10).mean().shift(-9)
tbl['lead_10d_std'] = tbl.cnt.rolling(10).std().shift(-9)

tbl.sort_values('Census_OSVersion_date', ascending=False, inplace=True)
tbl['lag_10d_sum']  = tbl.cnt.rolling(10).sum().shift(-9)
tbl['lag_10d_mean'] = tbl.cnt.rolling(10).mean().shift(-9)
tbl['lag_10d_std']  = tbl.cnt.rolling(10).std().shift(-9)

#tbl.set_index('Census_OSVersion_date', inplace=True)

tr_f = pd.DataFrame(tr['Census_OSVersion_date'])
te_f = pd.DataFrame(te['Census_OSVersion_date'])

tr_f = pd.merge(tr_f, tbl, on='Census_OSVersion_date', how='left')
te_f = pd.merge(te_f, tbl, on='Census_OSVersion_date', how='left')

del tr_f['Census_OSVersion_date'], te_f['Census_OSVersion_date']

utils.reduce_mem_usage(tr_f)
utils.reduce_mem_usage(te_f)

tr_f.add_prefix(PREF+'_').to_feather(f'../data/train_{PREF}.f')
te_f.add_prefix(PREF+'_').to_feather(f'../data/test_{PREF}.f')



utils.end(__file__)

