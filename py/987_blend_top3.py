#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Thu Mar 14 10:19:23 2019

@author: kazuki.onodera
"""

import numpy as np
import pandas as pd
import utils


SUBMIT_FILE_PATH = '../output/sashimi_aptx_tofu.csv.gz'

COMMENT = 'sashimi + aptx + tofu'

EXE_SUBMIT = True

usecols = ['HasDetections']

# =============================================================================
# 
# =============================================================================

sub_best = pd.read_csv(utils.SUB_BEST)

y_pred1 = pd.read_csv('../output/0313-3.csv.gz', usecols=usecols)['HasDetections'].rank()
y_pred2 = pd.read_csv('../external/sub/malware-super-shakedown-public-2nd-submit.zip', usecols=usecols)['HasDetections'].rank()
y_pred3 = pd.read_csv('../external/sub/final0.csv.gz', usecols=usecols)['HasDetections'].rank()

y_pred = y_pred1 + y_pred2 + y_pred3

sub = pd.read_csv('../input/sample_submission.csv.zip')
sub['HasDetections'] = y_pred.rank().values



pri_id = pd.read_pickle('../data/pri_id.pkl')['MachineIdentifier']

sub_pri = sub[sub.MachineIdentifier.isin(pri_id)]
sub_pub = sub[~sub.MachineIdentifier.isin(pri_id)]

sub_best_pri = sub_best[sub_best.MachineIdentifier.isin(pri_id)]
sub_best_pub = sub_best[~sub_best.MachineIdentifier.isin(pri_id)]



print(f'corr with {utils.SUB_BEST}')
print('with best(ALL):', sub['HasDetections'].corr( sub_best['HasDetections'], method='spearman') )
print('with best(pub):', sub_pub['HasDetections'].corr( sub_best_pub['HasDetections'], method='spearman') )
print('with best(pri):', sub_pri['HasDetections'].corr( sub_best_pri['HasDetections'], method='spearman') )

# save
sub.to_csv(SUBMIT_FILE_PATH, index=False, compression='gzip')

# =============================================================================
# submission
# =============================================================================
if EXE_SUBMIT:
    print('submit')
    utils.submit(SUBMIT_FILE_PATH, COMMENT)

